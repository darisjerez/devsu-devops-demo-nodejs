trigger:
- main

variables:
  AWS_REGION: us-east-2
  ECR_REPO: $(AWS_ACCOUNT_ID).dkr.ecr.$(AWS_REGION).amazonaws.com/devsu-demo-nodejs
  IMAGE_TAG: $(Build.BuildId)

pool:
  name: ec2-slave

stages:
  - stage: Test
    displayName: "Test"
    jobs:
      - job: UnitTests
        steps:
          - script: npm ci
            displayName: "Install dependencies"
          - script: npm run test
            displayName: "Run unit tests"
          - script: npm run test:coverage
            displayName: "Generate coverage report"

  - stage: Security
    displayName: "Security"
    dependsOn: Test
    jobs:
      - job: DependencyAudit
        displayName: "Dependency Audit"
        steps:
          - script: npm ci
            displayName: "Install dependencies"
          - script: npm audit --audit-level=high
            displayName: "Scan dependencies for vulnerabilities"
            continueOnError: true
      - job: SAST
        displayName: "Static Analysis"
        steps:
          - script: npm ci
            displayName: "Install dependencies"
          - script: npx eslint . --config .eslintrc.json
            displayName: "Run ESLint SAST analysis"
            continueOnError: true

  - stage: Build
    displayName: "Build & Push"
    dependsOn: Security
    jobs:
      - job: BuildImage
        steps:
          - script: aws ecr get-login-password --region $(AWS_REGION) | docker login --username AWS --password-stdin $(ECR_REPO)
            displayName: "ECR login"
          - script: docker build -t $(ECR_REPO):$(IMAGE_TAG) -t $(ECR_REPO):latest .
            displayName: "Build image"
          - script: docker push $(ECR_REPO):$(IMAGE_TAG) && docker push $(ECR_REPO):latest
            displayName: "Push image"

  - stage: ContainerScan
    displayName: "Container Scan"
    dependsOn: Build
    jobs:
      - job: TrivyScan
        steps:
          - script: |
              trivy image --severity HIGH,CRITICAL --exit-code 0 --format table $(ECR_REPO):$(IMAGE_TAG)
            displayName: "Trivy scan for HIGH/CRITICAL vulnerabilities"

  - stage: Deploy
    displayName: "Deploy to EKS"
    dependsOn: ContainerScan
    jobs:
      - job: HelmDeploy
        steps:
          - script: aws eks update-kubeconfig --region $(AWS_REGION) --name devsu-demo-eks
            displayName: "Configure kubectl"
          - script: |
              helm upgrade --install devsu-demo ./helm/devsu-demo \
                --namespace devsu --create-namespace \
                --set image.repository=$(ECR_REPO) \
                --set image.tag=$(IMAGE_TAG)
            displayName: "Helm deploy"
          - script: kubectl rollout status deployment/devsu-demo -n devsu --timeout=120s
            displayName: "Wait for rollout"
          - script: kubectl get svc -n devsu
            displayName: "Show service URL"
